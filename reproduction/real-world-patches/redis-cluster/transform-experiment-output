#!/usr/bin/env python
import os

OUTPUT_DIR = "../../data/real-world-patches"
OUTPUT_FILE_NAME = "realworldpatches.csv"

if not os.path.exists(OUTPUT_DIR):
    os.makedirs(OUTPUT_DIR)

OUTPUT_FILE = os.path.join(OUTPUT_DIR, OUTPUT_FILE_NAME);

if os.path.isfile(OUTPUT_FILE):
    print(OUTPUT_FILE + " already exists!")
    exit(0)

out = open(OUTPUT_FILE, "w") 
out.write("commit,number_patches,patch_size_byte,patch_time_ms\n")
for patch_dir in os.listdir("experiment-output"):
    commit = patch_dir.split("-")[1]
    patch_dir = os.path.join("experiment-output", patch_dir)

    patches = [os.path.join(patch_dir, f) for f in os.listdir(patch_dir) if f.startswith("patch--")]
    total_patch_size = sum(os.path.getsize(p) for p in patches)
    total_patches = len(patches)

    with open(os.path.join(patch_dir, "wf.log"), "r") as f:
        patched_line = [line for line in f.readlines() if line.startswith("- [patched, ")][0]
        patched_time = float(patched_line.split(",")[1].strip())
    out.write(f"{commit},{total_patches},{total_patch_size},{patched_time}\n")

out.close() 
print(f"Stored data in {OUTPUT_FILE}")
